<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="UTF-8">
    <title>Msg-perf-tool by orpiske</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" type="text/css" href="stylesheets/normalize.css" media="screen">
    <link href='https://fonts.googleapis.com/css?family=Open+Sans:400,700' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" type="text/css" href="stylesheets/stylesheet.css" media="screen">
    <link rel="stylesheet" type="text/css" href="stylesheets/github-light.css" media="screen">
  </head>
  <body>
    <section class="page-header">
      <h1 class="project-name">Msg-perf-tool</h1>
      <h2 class="project-tagline">MPT is a tool for running performance tests on AMQP-based messaging systems.</h2>
      <a href="https://github.com/orpiske/msg-perf-tool" class="btn">View on GitHub</a>
      <a href="https://github.com/orpiske/msg-perf-tool/zipball/master" class="btn">Download .zip</a>
      <a href="https://github.com/orpiske/msg-perf-tool/tarball/master" class="btn">Download .tar.gz</a>
    </section>

    <section class="main-content">
      <h1>
<a id="mpt-messaging-performance-tool" class="anchor" href="#mpt-messaging-performance-tool" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>MPT: messaging performance tool</h1>

<h2>
<a id="build-status" class="anchor" href="#build-status" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Build Status</h2>

<p>Linux Build Status: <a href="https://travis-ci.org/orpiske/msg-perf-tool"><img src="https://travis-ci.org/orpiske/msg-perf-tool.svg?branch=master" alt="Linux Build Status"></a> </p>

<h2>
<a id="introduction" class="anchor" href="#introduction" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Introduction:</h2>

<p>MPT is a tool for running performance tests on messaging systems current development
version supports AMQP and STOMP messaging protocols. Support for MQTT and OpenWire 
is planned for the future. The test data is saved in a CSV format and can be exported
to ElasticSearch DB. That allows it to be visualized using the 
<a href="https://github.com/orpiske/msg-perf-ui">Messaging Performance UI</a></p>

<h2>
<a id="dependencies" class="anchor" href="#dependencies" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Dependencies:</h2>

<p>Runtime/Compilation:</p>

<ul>
<li>cmake</li>
<li>gcc or clang</li>
<li>qpid-proton-c-devel</li>
<li>
<a href="https://github.com/orpiske/litestomp">litestomp</a> (optional) for STOMP support</li>
<li>python</li>
</ul>

<p>Recommended:</p>

<ul>
<li>iperf (as a good practice, for testing network performance prior to test execution)</li>
</ul>

<h2>
<a id="requirements" class="anchor" href="#requirements" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Requirements</h2>

<p>Disk Space:
The clients may generate a lot of data depending on how much messages are sent
per second. On my baseline system (two servers with Quad-Core AMD Opteron 2376 @ 8x 2.3GHz)
on a gigabit network, it generates around 1Gb of data per hour, transferring
around 66.000 messages per second.</p>

<p>Operating Systems:</p>

<ul>
<li>Linux: x86 and x86_64</li>
<li>OS X: x86</li>
</ul>

<h2>
<a id="broker-settings-activemq" class="anchor" href="#broker-settings-activemq" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Broker Settings: ActiveMQ</h2>

<p>ActiveMQ may need to have the inactivity monitor disabled. It can be done by
adding the following setting in the conf/activemq.xml, in the transport connector
setting:</p>

<pre><code>transport.useInactivityMonitor=false
</code></pre>

<p>For example:</p>

<pre><code>&lt;transportConnector name="amqp" uri="amqp://0.0.0.0:5672?maximumConnections=1000&amp;amp;wireFormat.maxFrameSize=104857600&amp;amp;transport.useInactivityMonitor=false"/&gt;
</code></pre>

<h2>
<a id="usage---performance-tool" class="anchor" href="#usage---performance-tool" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Usage - Performance Tool:</h2>

<p>Here's an example of how to run a 10 minute load test, with 4 concurrent senders,
4 concurrent receivers, sending 256 bytes of data per message. After test, the
performance report is uploaded via SCP to the server pointed by @:</p>

<pre><code>mpt-runner.sh -l /tmp/log -b amqp://&lt;amqp server&gt;:5672/&lt;queue name&gt; -d 10 -p 4 -s 256 -u &lt;user&gt;@&lt;host&gt;:&lt;path&gt; -n "sample test"
</code></pre>

<p>It's possible to have more complex deployment scenarios by running the sender and receiver separately. In this case, you have to
run the test steps manually:</p>

<p>Run the receiver (the controller will print the PID, please take note of that):</p>

<pre><code>mpt-receiver -b amqp://&lt;amqp server&gt;:5672/&lt;queue name&gt; --log-level=stat -d 10 -p 4 --logdir=/tmp/log --daemon
</code></pre>

<p>Run the sender (the controller will print the PID, please take note of that):</p>

<pre><code>mpt-sender -b amqp://&lt;amqp server&gt;:5672/&lt;queue name&gt; --log-level=stat -d 10 -p 4 --logdir=/tmp/log --daemon
</code></pre>

<p>This is all that is required for running very simple tests. For larger test 
scenarios or integration with other tools, please keep reading the sections 
below.</p>

<h2>
<a id="usage---elasticsearch-integration" class="anchor" href="#usage---elasticsearch-integration" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Usage - ElasticSearch Integration:</h2>

<p>The performance data generated by this tool can be exported to a 
<a href="https://www.elastic.co/">ElasticSearch</a> database so that it can be visualized 
in the <a href="https://github.com/orpiske/msg-perf-ui">Messaging Performance UI</a>.</p>

<p>Overall, the integration is pretty simple and requires only two modifications to 
the basic configuration. First, you need to configure it to allow Cross Origin 
Resource Sharing (CORS). To do so, add the following to the configuration file 
in config/elasticsearch.yml:</p>

<pre><code>http.cors.allow-origin: "*"
http.cors.enabled: true
</code></pre>

<p>It may also be necessary to configure it to listen on all interfaces (or, at 
least, the one desired), so that it can be accessed from anywhere. You can do so
 by setting the following parameter:</p>

<pre><code>network.host: 0.0.0.0
</code></pre>

<p>At the moment, it does not implement nor require any security configuration, 
therefore it's highly recommended to setup adequate security mechanisms on top 
of your instance for publicly available instances.</p>

<h2>
<a id="usage---runner" class="anchor" href="#usage---runner" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Usage - Runner:</h2>

<p>Dealing with the synchronization and parameters of performance can be daunting, 
though, therefore a runner script is available to simplify the execution. Before
running the runner, it's advised to create configuration files for both the 
application as well as the test scenario. The file configuration should be simple 
and self-explanatory, since they match the same name of the test parameters.</p>

<pre><code>mpt-runner.sh -l /path/to/log -t 5000 -b &lt;protocol&gt;://&lt;host&gt;:&lt;port&gt;/queue/&lt;queue&gt; -d 5 -p 1 -s 32 -C /path/to/mpt-loader.conf -T /path/to/stomp-small-test.conf -R 002
</code></pre>

<p>Attention: the runner requires a ElasticSearch database. This behavior will be 
changed in the future.</p>

<h2>
<a id="usage---loader" class="anchor" href="#usage---loader" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Usage - Loader</h2>

<p>These steps are automatically handled by the runner, however, in case you need 
to run them, this is how it works:</p>

<p>The first step is to register the Software Under Test in the database: </p>

<pre><code>mpt-loader.py --register \
    --sut-key "activemq" \
    --sut-name "ActiveMQ" \
    --sut-version "5.13.3"  \
    --url http://localhost:9200/
</code></pre>

<p>The second is to record the test info. This part should contain the details about 
the test (messaging parameters, hardware information, etc)</p>

<pre><code>mpt-loader.py --testinfo --url http://localhost:9200 \
        --test-run "001" \
        --sut-key "activemq" \
        --test-start-time "20167-11 14:48:03" \
        --test-duration 5m \
        --broker-sys-os-version 24 \
        --broker-sys-os-name Fedora \
        --broker-sys-os-type Linux  \
        --test-comment "Small local test on Fedora 24" \
        --test-result-comment "Run ok, no comments" \
        --broker-sys-info "Thinkpad T450/12Gb RAM/521gb SSD" \
        --consumer-sys-info "Thinkpad T450/12Gb RAM/521gb SSD" \
        --producer-sys-info "Thinkpad T450/12Gb RAM/521gb SSD"  \
        --msg-endpoint-type "queue"
</code></pre>

<p>After the SUT and test information is recorded, the test result information can
be loaded in 3 steps:</p>

<p>Load sender throughput data:</p>

<pre><code>mpt-loader.py --load throughput \
        --url http://localhost:9200 \
        --sut-name "ActiveMQ" \
        --sut-key activemq \
        --sut-version "5.13.3" \
        --test-run "001" \
        --msg-direction sender \
        --filename /path/to/sender-throughput-&lt;pid&gt;.csv
</code></pre>

<p>Load receiver latency data:</p>

<pre><code>mpt-loader.py --load latency \
        --url http://localhost:9200 \
        --sut-name "ActiveMQ" \
        --sut-key activemq \
        --sut-version "5.13.3" \
        --test-run "001" \
        --msg-direction receiver \
        --filename /path/to/receiver-latency-&lt;pid&gt;.csv
</code></pre>

<p>Load receiver throughput data:</p>

<pre><code>mpt-loader.py --load throughput \
        --url http://localhost:9200 \
        --sut-name "ActiveMQ" \
        --sut-key activemq \
        --sut-version "5.13.3" \
        --test-run "001" \
        --msg-direction receiver \
        --filename /path/to/receiver-throughput-&lt;pid&gt;.csv
</code></pre>

<p>Most of the test parameters to a configuration file and have the loader use it 
(ie.: using --config and --config-test). It uses 2 separate configuration files:
 one contains the application configuration (ie.: URL for ES) and the other 
contains the test parameters. For example:</p>

<pre><code>    mpt-loader.py --load latency \
        --config /path/to/application/config \
        --config-test /path/to/test/config \
        --test-run 001 \
        --msg-direction receiver \
        --filename /path/to/receiver-latency-&lt;pid&gt;.csv
</code></pre>

<p>The binaries provide configuration samples that can be modified: </p>

<ul>
<li>Loader configuration: /usr/share/mpt/mpt-loader.conf</li>
<li>Test case configuration: /usr/share/mpt/sample-test-case.conf</li>
</ul>

<p>The configuration parameters are the same as passed from the command line.</p>

<h2>
<a id="binaries" class="anchor" href="#binaries" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Binaries</h2>

<p>Binaries for this tool, for Fedora, CentOS and RHEL, can be found on my COPR at
<a href="https://copr.fedorainfracloud.org/coprs/orpiske/msg-perf-tool/">https://copr.fedorainfracloud.org/coprs/orpiske/msg-perf-tool/</a></p>

<h2>
<a id="tips" class="anchor" href="#tips" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Tips</h2>

<ul>
<li>Run the clients and the broker in different servers</li>
<li>Make sure that the time is properly set on both servers</li>
<li>Run on an dedicated network (or, at least, avoid hours of peak usage)</li>
<li>Measure the network performance before running (ie.: use iperf)</li>
<li>Ideally, you should run at a fixed rate instead of flooding the brokers.
Brokers tend to get slower as the queue size increase.</li>
</ul>

<h2>
<a id="license" class="anchor" href="#license" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>License</h2>

<p>The code is licensed under Apache License v2</p>

      <footer class="site-footer">
        <span class="site-footer-owner"><a href="https://github.com/orpiske/msg-perf-tool">Msg-perf-tool</a> is maintained by <a href="https://github.com/orpiske">orpiske</a>.</span>

        <span class="site-footer-credits">This page was generated by <a href="https://pages.github.com">GitHub Pages</a> using the <a href="https://github.com/jasonlong/cayman-theme">Cayman theme</a> by <a href="https://twitter.com/jasonlong">Jason Long</a>.</span>
      </footer>

    </section>

  
  </body>
</html>
